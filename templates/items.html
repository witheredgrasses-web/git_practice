{% extends "base.html" %}

{% block content %}
  <h2>商品一覧</h2>

  {% if items %}
    <table>
      <thead>
        <tr>
          <th>商品名</th>
          <th>在庫数</th>
          <th>カテゴリ</th>
          <th>仕入先</th>
          <th>操作</th>
          {% if g.user and g.user["role"] == "admin" %}
            <th>管理</th>
          {% endif %}
        </tr>
      </thead>

      <tbody>
        {% for item in items %}
          <tr class="{% if item.stock < item.threshold %}low-stock{% endif %}">
            <td>{{ item.name }}</td>
            <td>{{ item.stock }} ({{ item.unit }})</td>
            <td>{{ item.category_name or "-" }}</td>
            <td>{{ item.supplier_name or "-" }}</td>
            <td>
              <form method="post" action="{{ url_for('update_stock') }}" style="display:inline-flex; gap:4px; align-items:center;">

                <input type="hidden" name="item_id" value="{{ item.id }}">

                <button type="submit" name="action" value="in">増</button>
                <button type="submit" name="action" value="out">減</button>

                <input type="number" name="quantity" value="1" min="1" style="width:60px;">

                <input type="text" name="memo" placeholder="メモ" style="width:120px;">

                {% if item.stock < item.threshold %}
                  <span class="alert-text">入庫してください</span>
                {% endif %}
              </form>
            </td>

            {% if g.user and g.user["role"] == "admin" %}
              <td>
                <form method="post" action="{{ url_for('item_delete', item_id=item.id) }}" style="display:inline;">
                  <button type="submit" onclick="return confirm('{{ item.name }} を削除しますか？');">
                    削除
                  </button>
                </form>
              </td>
            {% endif %}
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p>登録されている商品はまだありません。</p>
  {% endif %}

  {% if g.user and g.user["role"] == "admin" %}
    <hr>

    <h3>＋ 商品登録</h3>
    <button type="button" onclick="toggleForm()">商品登録フォームを開く / 閉じる</button>

    <div id="register-form">
      <form method="post" action="{{ url_for('item_create') }}">
        <div>
          <label>商品名（必須）</label><br>
          <input type="text" name="name" required>
        </div>

        <div>
          <label>単位（必須：個・箱など）</label><br>
          <input type="text" name="unit" required>
        </div>

        <div>
          <label>初期在庫数（任意・数字）</label><br>
          <input type="number" name="stock" value="0">
        </div>

        <div>
          <label>在庫警告のしきい値（任意・数字）</label><br>
          <input type="number" name="threshold" value="0">
        </div>

        <div>
          <label>カテゴリ（任意）</label><br>
          <select name="category_id">
            <option value="">未選択</option>
            {% for cat in categories %}
              <option value="{{ cat.id }}">{{ cat.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div>
          <label>仕入先（任意）</label><br>
          <select name="supplier_id">
            <option value="">未選択</option>
            {% for sup in suppliers %}
              <option value="{{ sup.id }}">{{ sup.name }}</option>
            {% endfor %}
          </select>
        </div>

        <br>
        <button type="submit">登録する</button>
        <button type="button" onclick="toggleForm()">閉じる</button>
      </form>
    </div>

    <script>
      function toggleForm() {
        const f = document.getElementById("register-form");
        if (f.style.display === "none" || f.style.display === "") {
          f.style.display = "block";
        } else {
          f.style.display = "none";
        }
      }
    </script>
  {% endif %}
{% endblock %}
